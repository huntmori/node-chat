import express, { Application, Request, Response } from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import path from 'path';
import { testConnection } from './config/database';
import indexRouter from './routes/index';
import * as WebSocket from 'ws';
import http from 'http';

dotenv.config();

// WebSocket 연결 관리자
export class ConnectionManager {
  private static connections: Set<WebSocket> = new Set();

  static add(ws: WebSocket) {
    this.connections.add(ws);
  }

  static remove(ws: WebSocket) {
    this.connections.delete(ws);
  }

  static getCount(): number {
    return this.connections.size;
  }

  static broadcast(message: string) {
    this.connections.forEach((client) => {
      if ((client as any).readyState === WebSocket.OPEN) {
        (client as any).send(message);
      }
    });
  }
}

const app: Application = express();
const PORT = parseInt(process.env.PORT || '3000', 10) || 3000;

// View engine setup
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, '../views'));

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, '../public')));

// Routes
app.use('/', indexRouter);

app.get('/health', (req: Request, res: Response) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// Start server: create a single HTTP server and attach WebSocket.Server to it
const startServer = async () => {
  try {
    // Test database connection (optional)
    try {
      await testConnection();
    } catch (dbError) {
      console.warn('⚠ Database connection failed, but server will continue running');
      console.warn('Please check your .env file and MariaDB configuration');
    }

    // Create HTTP server from express app
    const server = http.createServer(app);

    // Attach WebSocket server to the same HTTP server
    const wsServer = new WebSocket.Server({ server });

    wsServer.on('connection', (ws: WebSocket) => {
      ConnectionManager.add(ws);
      console.log(`✓ New WebSocket connection (Total: ${ConnectionManager.getCount()})`);

      // 'open' is not emitted on server-side socket; keep message/close handlers
      ws.on('message', (message: WebSocket.Data) => {
        // Normalize message to string for broadcasting
        const text = typeof message === 'string' ? message : message.toString();
        console.log('Received message:', text);
        ConnectionManager.broadcast(text);
      });

      ws.on('close', () => {
        ConnectionManager.remove(ws);
        console.log(`✓ WebSocket connection closed (Total: ${ConnectionManager.getCount()})`);
      });

      ws.on('error', (err) => {
        console.error('WebSocket error:', err);
      });
    });

    // Start listening on single port
    server.listen(PORT, () => {
      console.log(`✓ Server (HTTP + WebSocket) is running on port ${PORT}`);
      console.log(`✓ Environment: ${process.env.NODE_ENV || 'development'}`);
      console.log(`✓ Visit: http://localhost:${PORT}`);
    });
  } catch (error) {
    console.error('Failed to start server:', error);
    process.exit(1);
  }
};

startServer();

export default app;
